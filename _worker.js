import{connect as I}from"cloudflare:sockets";let D="",A="",P="",x="SUBAPI.fxxk.dedyn.io",E="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",k="https",O="true",N="",pe={},J=!1,W,F,Z="false";const ue=4102329600;let K,V,Y=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],Q=[],B=[],G=[],H=[],z=[],X=8,de=1,_=atob("ZWRnZXR1bm5lbA=="),q,ee,M=[],te="false",ae=["2053","2083","2087","2096","8443"],re=7,ne=3,he,S=[],se="/?ed=2560",oe;export default{async fetch(e,t,a){try{var r,n=e.headers.get("User-Agent")||"null",s=n.toLowerCase();if(D=t.UUID||t.uuid||t.PASSWORD||t.pswd||D,(t.KEY||t.TOKEN||D&&!me(D))&&(oe=t.KEY||t.TOKEN||D,re=Number(t.TIME)||re,ne=Number(t.UPTIME)||ne,r=await function(e){const t=new Date(2007,6,7,ne,0,0),a=864e5*re;function r(e){e=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",e).then(e=>{e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("");return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${(63&parseInt(e.substr(16,2),16)|128).toString(16)}${e.substr(18,2)}-`+e.substr(20,12)})}var n=function(){var e=new Date,e=new Date(e.getTime()+288e5),e=Number(e)-Number(t);return Math.ceil(e/a)}(),s=new Date(t.getTime()+n*a),o=r(e+n),e=r(e+(n-1)),n=new Date(s.getTime()-288e5),n=`到期时间(UTC): ${n.toISOString().slice(0,19).replace("T"," ")} (UTC+8): ${s.toISOString().slice(0,19).replace("T"," ")}
`;return Promise.all([o,e,n])}(oe),D=r[0],he=r[1]),!D)return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});var o=new Date,l=(o.setHours(0,0,0,0),Math.ceil(o.getTime()/1e3)),i=(U=""+D+l,y=new TextEncoder,U=await crypto.subtle.digest("MD5",y.encode(U)),U=(U=Array.from(new Uint8Array(U))).map(e=>e.toString(16).padStart(2,"0")).join(""),y=await crypto.subtle.digest("MD5",y.encode(U.slice(7,27))),U=Array.from(new Uint8Array(y)),await(y=U.map(e=>e.toString(16).padStart(2,"0")).join("")).toLowerCase());if(W=[i.slice(0,8),i.slice(8,12),i.slice(12,16),i.slice(16,20),i.slice(20)].join("-"),F=i.slice(6,9)+"."+i.slice(13,19),A=t.PROXYIP||t.proxyip||A,K=await ce(A),A=K[Math.floor(Math.random()*K.length)],N=t.SOCKS5||N,V=await ce(N),N=(N=V[Math.floor(Math.random()*V.length)]).split("//")[1]||N,t.GO2SOCKS5&&(Y=await ce(t.GO2SOCKS5)),t.CFPORTS&&(ae=await ce(t.CFPORTS)),N)try{pe=Me(N),te=t.RPROXYIP||"false",J=!0}catch(e){var c=e;console.log(c.toString()),te=t.RPROXYIP||!A?"true":"false",J=!1}else te=t.RPROXYIP||!A?"true":"false";var p,u,d,h,w,m,f,M,S=e.headers.get("Upgrade"),g=new URL(e.url);if(S&&"websocket"===S){if(N=g.searchParams.get("socks5")||N,new RegExp("/socks5=","i").test(g.pathname))N=g.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(g.pathname)||new RegExp("/socks5://","i").test(g.pathname))&&(N=g.pathname.split("://")[1].split("#")[0]).includes("@")){let e=N.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(e)&&!e.includes(":")&&(e=atob(e)),N=e+"@"+N.split("@")[1]}if(N)try{pe=Me(N),J=!0}catch(e){var b=e;console.log(b.toString()),J=!1}else J=!1;g.searchParams.has("proxyip")?(A=g.searchParams.get("proxyip"),J=!1):new RegExp("/proxyip=","i").test(g.pathname)?(A=g.pathname.toLowerCase().split("/proxyip=")[1],J=!1):new RegExp("/proxyip.","i").test(g.pathname)&&(A="proxyip."+g.pathname.toLowerCase().split("/proxyip.")[1],J=!1);{var $=e;const C=new WebSocketPair,[j,T]=Object.values(C);T.accept();let p="",u="";const R=(e,t)=>{console.log(`[${p}:${u}] `+e,t||"")},L=$.headers.get("sec-websocket-protocol")||"",v=function(r,n,s){let o=!1;var e=new ReadableStream({start(t){r.addEventListener("message",e=>{o||(e=e.data,t.enqueue(e))}),r.addEventListener("close",()=>{le(r),o||t.close()}),r.addEventListener("error",e=>{s("WebSocket 服务器发生错误"),t.error(e)});var{earlyData:e,error:a}=function(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var t=atob(e);return{earlyData:Uint8Array.from(t,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}(n);a?t.error(a):e&&t.enqueue(e)},pull(e){},cancel(e){o||(s("可读流被取消，原因是 "+e),o=!0,le(r))}});return e}(T,L,R);let d={value:null},h=!1;return await(v.pipeTo(new WritableStream({async write(e,t){if(h)return fe(e,T,null,R);if(d.value)await(a=d.value.writable.getWriter()).write(e),a.releaseLock();else{var{hasError:a,message:r,addressType:n,portRemote:s=443,addressRemote:o="",rawDataIndex:l,"维列斯Version":i=new Uint8Array([0,0]),isUDP:c}=function(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};var a=new Uint8Array(e.slice(0,1));let r=!1;function n(e,t,a){a=function(e,t=0){e=function(e,t=0){return(ie[e[t+0]]+ie[e[t+1]]+ie[e[t+2]]+ie[e[t+3]]+"-"+ie[e[t+4]]+ie[e[t+5]]+"-"+ie[e[t+6]]+ie[e[t+7]]+"-"+ie[e[t+8]]+ie[e[t+9]]+"-"+ie[e[t+10]]+ie[e[t+11]]+ie[e[t+12]]+ie[e[t+13]]+ie[e[t+14]]+ie[e[t+15]]).toLowerCase()}(e,t);if(me(e))return e;throw TypeError("生成的 UUID 不符合规范 "+e)}(new Uint8Array(a.slice(1,17)));return a===e||a===t}if(!n(t,he,e))return{hasError:!0,message:"invalid user "+new Uint8Array(e.slice(1,17))};var t=new Uint8Array(e.slice(17,18))[0],s=new Uint8Array(e.slice(18+t,18+t+1))[0];if(1!==s){if(2!==s)return{hasError:!0,message:`command ${s} is not support, command 01-tcp,02-udp,03-mux`};r=!0}s=18+t+1,t=e.slice(s,s+2),t=new DataView(t).getUint16(0);s+=2;var o=new Uint8Array(e.slice(s,s+1)),l=o[0];let i=0,c=s+1,p="";switch(l){case 1:i=4,p=new Uint8Array(e.slice(c,c+i)).join(".");break;case 2:i=new Uint8Array(e.slice(c,c+1))[0],c+=1,p=(new TextDecoder).decode(e.slice(c,c+i));break;case 3:i=16;var u=new DataView(e.slice(c,c+i)),d=[];for(let e=0;e<8;e++)d.push(u.getUint16(2*e).toString(16));p=d.join(":");break;default:return{hasError:!0,message:"invild addressType is "+l}}return p?{hasError:!1,addressRemote:p,addressType:l,portRemote:t,rawDataIndex:c+i,"维列斯Version":a,isUDP:r}:{hasError:!0,message:"addressValue is empty, addressType is "+l}}(e,D);if(p=o,u=`${s}--${Math.random()} ${c?"udp ":"tcp "} `,a)throw new Error(r);if(c){if(53!==s)throw new Error("UDP 代理仅对 DNS（53 端口）启用");h=!0}a=new Uint8Array([i[0],0]),r=e.slice(l);if(h)return fe(r,T,a,R);R(`处理 TCP 出站连接 ${o}:`+s),!async function(r,n,e,t,s,a,o,l){async function i(e,t,a=!1){l(`connected to ${e}:`+t);a=a?await async function(t,a,r,n){var{username:s,password:o,hostname:l,port:i}=pe,l=I({hostname:l,port:i}),i=new Uint8Array([5,2,0,2]),c=l.writable.getWriter(),i=(await c.write(i),n("已发送 SOCKS5 问候消息"),l.readable.getReader()),p=new TextEncoder;let u=(await i.read()).value;if(5!==u[0])n(`SOCKS5 服务器版本错误: 收到 ${u[0]}，期望是 5`);else if(255===u[1])n("服务器不接受任何认证方法");else{if(2===u[1]){if(n("SOCKS5 服务器需要认证"),!s||!o)return void n("请提供用户名和密码");s=new Uint8Array([1,s.length,...p.encode(s),o.length,...p.encode(o)]);if(await c.write(s),1!==(u=(await i.read()).value)[0]||0!==u[1])return void n("SOCKS5 服务器认证失败")}let e;switch(t){case 1:e=new Uint8Array([1,...a.split(".").map(Number)]);break;case 2:e=new Uint8Array([3,a.length,...p.encode(a)]);break;case 3:e=new Uint8Array([4,...a.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void n("无效的地址类型: "+t)}o=new Uint8Array([5,1,0,...e,r>>8,255&r]);if(await c.write(o),n("已发送 SOCKS5 请求"),0===(u=(await i.read()).value)[1])return n("SOCKS5 连接已建立"),c.releaseLock(),i.releaseLock(),l;n("SOCKS5 连接建立失败")}}(n,e,t,l):I({hostname:e,port:t}),e=(r.value=a).writable.getWriter();return await e.write(s),e.releaseLock(),a}let c=!1;0<Y.length&&J&&(c=await async function(t){return!(!Y.includes(atob("YWxsIGlu"))&&!Y.includes(atob("Kg==")))||Y.some(e=>{e=e.replace(/\*/g,".*");return new RegExp(`^${e}$`,"i").test(t)})}(e));let p=await i(e,t,c);we(p,a,o,async function(){(p=J?await i(e,t,!0):(A&&""!=A?A.includes("]:")?(t=A.split("]:")[1]||t,A=A.split("]:")[0]||A):2===A.split(":").length&&(t=A.split(":")[1]||t,A=A.split(":")[0]||A):A=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),A.includes(".tp")&&(t=A.split(".tp")[1].split(".")[0]||t),await i(A||e,t))).closed.catch(e=>{console.log("retry tcpSocket closed error",e)}).finally(()=>{le(a)}),we(p,a,o,null,l)},l)}(d,n,o,s,r,T,a,R)}},close(){R("readableWebSocketStream 已关闭")},abort(e){R("readableWebSocketStream 已中止",JSON.stringify(e))}})).catch(e=>{R("readableWebSocketStream 管道错误",e)}),new Response(null,{status:101,webSocket:j}));return await void 0}}return t.ADD&&(Q=await ce(t.ADD)),t.ADDAPI&&(B=await ce(t.ADDAPI)),t.ADDNOTLS&&(G=await ce(t.ADDNOTLS)),t.ADDNOTLSAPI&&(H=await ce(t.ADDNOTLSAPI)),t.ADDCSV&&(z=await ce(t.ADDCSV)),X=Number(t.DLS)||X,de=Number(t.CSVREMARK)||de,q=t.TGTOKEN||q,ee=t.TGID||ee,_=t.SUBNAME||_,"0"==(O=t.SUBEMOJI||t.EMOJI||O)&&(O="false"),P=t.SUB||P,(x=t.SUBAPI||x).includes("http://")?(x=x.split("//")[1],k="http"):x=x.split("//")[1]||x,E=t.SUBCONFIG||E,g.searchParams.has("sub")&&""!==g.searchParams.get("sub")&&(P=g.searchParams.get("sub")),g.searchParams.has("notls")&&(Z="true"),g.searchParams.has("proxyip")?(se="/?ed=2560&proxyip="+g.searchParams.get("proxyip"),te="false"):g.searchParams.has("socks5")?(se="/?ed=2560&socks5="+g.searchParams.get("socks5"),te="false"):g.searchParams.has("socks")&&(se="/?ed=2560&socks5="+g.searchParams.get("socks"),te="false"),"/"==(p=g.pathname.toLowerCase())?t.URL302?Response.redirect(t.URL302,302):t.URL?await Se(t.URL,g):new Response(JSON.stringify(e.cf,null,4),{status:200,headers:{"content-type":"application/json"}}):p=="/"+W?(u=await ge(D,e.headers.get("Host"),P,"CF-Workers-SUB",te,g),new Response(""+u,{status:200})):p=="/"+oe||p=="/"+D?(await async function(t,a,r=""){if(q&&ee)try{let e="";var n,s=await fetch(`http://ip-api.com/json/${a}?lang=zh-CN`),o=(e=s.ok?(n=await s.json(),`${t}
IP: ${a}
国家: ${n.country}
<tg-spoiler>城市: ${n.city}
组织: ${n.org}
ASN: ${n.as}
`+r):t+`
IP: ${a}
<tg-spoiler>`+r,`https://api.telegram.org/bot${q}/sendMessage?chat_id=${ee}&parse_mode=HTML&text=`+encodeURIComponent(e));return fetch(o,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}catch(e){console.error("Error sending message:",e)}}("#获取订阅 "+_,e.headers.get("CF-Connecting-IP"),`UA: ${n}</tg-spoiler>
域名: ${g.hostname}
<tg-spoiler>入口: ${g.pathname+g.search}</tg-spoiler>`),d=await ge(D,e.headers.get("Host"),P,n,te,g),h=Date.now(),(w=new Date(h)).setHours(0,0,0,0),f=m=Math.floor((h-w.getTime())/864e5*.01*1099511627776/2),M=0xf00000000000,s&&s.includes("mozilla")?new Response(""+d,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${m}; download=${f}; total=${M}; expire=`+ue}}):new Response(""+d,{status:200,headers:{"Content-Disposition":`attachment; filename=${_}; filename*=utf-8''`+encodeURIComponent(_),"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${m}; download=${f}; total=${M}; expire=`+ue}})):t.URL302?Response.redirect(t.URL302,302):t.URL?await Se(t.URL,g):new Response("",{status:404})}catch(e){return new Response(e.toString())}var U,y}};async function we(e,a,t,r,n){let s=t,o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,t){o=!0,a.readyState!==i&&t.error("webSocket.readyState is not open, maybe close"),s?(a.send(await new Blob([s,e]).arrayBuffer()),s=null):a.send(e)},close(){n("remoteConnection!.readable is close with hasIncomingData is "+o)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch(e=>{console.error("remoteSocketToWS has exception ",e.stack||e),le(a)}),!1===o&&r&&(n("retry"),r())}function me(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}const i=1,t=2;function le(e){try{e.readyState!==i&&e.readyState!==t||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}const ie=[];for(let e=0;e<256;++e)ie.push((e+256).toString(16).slice(1));async function fe(e,a,r,n){try{const l="8.8.4.4";let t=r;var s=I({hostname:l,port:53}),o=(n(`连接到 ${l}:53`),s.writable.getWriter());await o.write(e),o.releaseLock(),await s.readable.pipeTo(new WritableStream({async write(e){a.readyState===i&&(t?(a.send(await new Blob([t,e]).arrayBuffer()),t=null):a.send(e))},close(){n(`DNS 服务器(${l}) TCP 连接已关闭`)},abort(e){console.error(`DNS 服务器(${l}) TCP 连接异常中断`,e)}}))}catch(e){console.error("handleDNSQuery 函数发生异常，错误信息: "+e.message)}}function Me(e){var[e,t]=e.split("@").reverse();let a,r,n,s;if(t){t=t.split(":");if(2!==t.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[a,r]=t}t=e.split(":");if(s=Number(t.pop()),isNaN(s))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");if((n=t.join(":")).includes(":")&&!/^\[.*\]$/.test(n))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:a,password:r,hostname:n,port:s}}async function Se(e,t){var e=await ce(e),e=e[Math.floor(Math.random()*e.length)],e=new URL(e),a=(console.log(e),e.protocol.slice(0,-1)||"https"),r=e.hostname;let n=e.pathname;e=e.search,"/"==n.charAt(n.length-1)&&(n=n.slice(0,-1)),a=a+"://"+r+(n+=t.pathname)+e,r=await fetch(a),t=new Response(r.body,{status:r.status,statusText:r.statusText,headers:r.headers});return t.headers.set("X-New-URL",a),t}const g=atob("ZG14bGMzTT0=");let b=["sub","base64","b64","clash","singbox","sb"];async function ge(l,i,c,p,u,d){function t(e){var[e,t]=e.split("/"),e=e.split(".").map(Number);const a=32-parseInt(t,10);t=Math.pow(2,a)-1;const r=Math.floor(Math.random()*t);return e.map((e,t)=>t<2?e:2===t?(e&255<<a-8)+(r>>8&255):(e&255<<a)+(255&r)).join(".")}c?1<(a=await ce(c=(a=c.match(/^(?:https?:\/\/)?([^\/]+)/))?a[1]:c)).length&&(c=a[0]):Q.length+B.length+G.length+H.length+z.length==0&&(a=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"],Q=Q.concat("127.0.0.1:1234#CFnat"),i.includes(".workers.dev")?G=G.concat(a.map(e=>t(e)+"#CF随机节点")):Q=Q.concat(a.map(e=>t(e)+"#CF随机节点")));var h,w,m,f,a=d.pathname=="/"+oe?oe:l,e=p.toLowerCase(),r=function(e,t){var a=atob(g),r=_;let n=t,s=443;var o=t,l=se;let i=["tls",!0];var c=t,p="randomized";return t.includes(".workers.dev")&&(n=atob("dmlzYS5jbg=="),s=80,i=["",!1]),[t=""+a+`://${e}@${n}:${s}?encry`+"p"+atob("dGlvbj0=")+"none"+`&security=${i[0]}&sni=${c}&fp=${p}&type=ws&host=${o}&path=${encodeURIComponent(l)}#`+encodeURIComponent(r),`- type: ${a}
  name: ${_}
  server: ${n}
  port: ${s}
  uuid: ${e}
  network: ws
  tls: ${i[1]}
  udp: false
  sni: ${c}
  client-fingerprint: ${p}
  ws-opts:
  path: "${l}"
  headers:
    host: `+o]}(l,i),n=r[0],r=r[1];let s="";if(i.includes(".workers.dev")&&0!=M.length&&(s=M[Math.floor(Math.random()*M.length)]+"/"),e.includes("mozilla")&&!b.some(e=>d.searchParams.has(e))){var o=V.map(e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e);let e="",t=(0<Y.length&&J&&(e=""+decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20"),Y.includes(atob("YWxsIGlu"))||Y.includes(atob("Kg=="))?e+=decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")+`
`:e+=`
  ${Y.join("\n  ")}
`),"\n");c?(J?t+=`CFCDN（访问方式）: Socks5
  ${o.join("\n  ")}
`+e:A&&""!=A?t+=`CFCDN（访问方式）: ProxyIP
  ${K.join("\n  ")}
`:t+="true"==u?`CFCDN（访问方式）: 自动获取ProxyIP
`:`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,t+=`
SUB（优选订阅生成器）: `+c):(J?t+=`CFCDN（访问方式）: Socks5
  ${o.join("\n  ")}
`+e:A&&""!=A?t+=`CFCDN（访问方式）: ProxyIP
  ${K.join("\n  ")}
`:t+=`CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！
`,t+=`
您的订阅内容由 内置 addresses/ADD* 参数变量提供
`,0<Q.length&&(t+=`ADD（TLS优选域名&IP）: 
  ${Q.join("\n  ")}
`),0<G.length&&(t+=`ADDNOTLS（noTLS优选域名&IP）: 
  ${G.join("\n  ")}
`),0<B.length&&(t+=`ADDAPI（TLS优选域名&IP 的 API）: 
  ${B.join("\n  ")}
`),0<H.length&&(t+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: 
  ${H.join("\n  ")}
`),0<z.length&&(t+=`ADDCSV（IPTest测速csv文件 限速 ${X} ）: 
  ${z.join("\n  ")}
`)),oe&&d.pathname!=="/"+oe?t="":t+=`
SUBAPI（订阅转换后端）: ${k}://${x}
SUBCONFIG（订阅转换配置文件）: `+E;o=a!=l?`TOKEN: ${a}
UUIDNow: ${l}
UUIDLow: ${he}
${""}TIME（动态UUID有效时间）: ${re} 天
UPTIME（动态UUID更新时间）: ${ne} 时（北京时间）

`:"";return`
################################################################
Subscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式
---------------------------------------------------------------
快速自适应订阅地址:
https://${s}${i}/${a}
https://${s}${i}/${a}?sub

Base64订阅地址:
https://${s}${i}/${a}?b64
https://${s}${i}/${a}?base64

clash订阅地址:
https://${s}${i}/${a}?clash

singbox订阅地址:
https://${s}${i}/${a}?sb
https://${s}${i}/${a}?singbox
---------------------------------------------------------------
################################################################
${_} 配置信息
---------------------------------------------------------------
${o}HOST: ${i}
UUID: ${l}
FKID: ${W}
UA: ${p}
${t}
---------------------------------------------------------------
################################################################
v2ray
---------------------------------------------------------------
${n}
---------------------------------------------------------------
################################################################
clash-meta
---------------------------------------------------------------
${r}
---------------------------------------------------------------
################################################################
${decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhCmh0dHBzJTNBJTJGJTJGdC5tZSUyRkNNTGl1c3NzcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISEKaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlZGdldHVubmVsCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="))}
`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let t=[],a=[],r=[],n=[],s=(i.includes(".workers.dev")?(Z="true",F+=".workers.dev",r=await $(H),n=await U("FALSE")):i.includes(".pages.dev")?F+=".pages.dev":i.includes("worker")||i.includes("notls")||"true"==Z?(Z="true",F=`notls${F}.net`,r=await $(H),n=await U("FALSE")):F+=".xyz",console.log("虚假HOST: "+F),`${k}://${c}/sub?host=${F}&uuid=${W+atob("JmVkZ2V0dW5uZWw9Y21saXUmcHJveHlpcD0=")+u}&path=`+encodeURIComponent(se)),o=!0;c&&""!=c||(i.includes("workers.dev")&&(M=[...new Set(M)]),t=await $(B),a=await U("TRUE"),s=`https://${i}/`+(W+d.search),(i.includes("worker")||i.includes("notls")||"true"==Z)&&(d.search?s+="&notls":s+="?notls"),console.log("虚假订阅: "+s)),e.includes("CF-Workers-SUB".toLowerCase())||(e.includes("clash")&&!e.includes("nekobox")||d.searchParams.has("clash")&&!e.includes("subconverter")?(s=`${k}://${x}/sub?target=clash&url=${encodeURIComponent(s)}&insert=false&config=${encodeURIComponent(E)}&emoji=${O}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,o=!1):(e.includes("sing-box")||e.includes("singbox")||(d.searchParams.has("singbox")||d.searchParams.has("sb"))&&!e.includes("subconverter"))&&(s=`${k}://${x}/sub?target=singbox&url=${encodeURIComponent(s)}&insert=false&config=${encodeURIComponent(E)}&emoji=${O}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,o=!1));try{let e;return e=c&&""!=c||1!=o?await(await fetch(s,{headers:{"User-Agent":p+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ==")}})).text():await function(i,c,e,t,a,r,n){const p=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;Q=(Q=Q.concat(t)).concat(a);let s;"true"==e&&(G=(G=G.concat(r)).concat(n),t=[...new Set(G)],s=t.map(e=>{let t="-1",a=e;var r=a.match(p);r?(e=r[1],t=r[2]||t,a=r[3]||e):(e.includes(":")&&e.includes("#")?(e=(r=e.split(":"))[0],r=r[1].split("#"),t=r[0],a=r[1]):e.includes(":")?(e=(r=e.split(":"))[0],t=r[1]):e.includes("#")&&(e=(r=e.split("#"))[0],a=r[1]),a.includes(":")&&(a=a.split(":")[0]));if(!y(e)&&"-1"==t)for(var n of["8080","8880","2052","2082","2086","2095"])if(e.includes(n)){t=n;break}"-1"==t&&(t="80");var r=i,s=se;return`${atob(g)}://${c}@${e}:${t+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+r}&path=${encodeURIComponent(s)}#`+encodeURIComponent(a+"")}).join("\n"));a=[...new Set(Q)],r=a.map(t=>{let e="-1",a=t;var r=a.match(p);if(r?(t=r[1],e=r[2]||e,a=r[3]||t):(t.includes(":")&&t.includes("#")?(t=(r=t.split(":"))[0],r=r[1].split("#"),e=r[0],a=r[1]):t.includes(":")?(t=(r=t.split(":"))[0],e=r[1]):t.includes("#")&&(t=(r=t.split("#"))[0],a=r[1]),a.includes(":")&&(a=a.split(":")[0])),!y(t)&&"-1"==e)for(var n of ae)if(t.includes(n)){e=n;break}"-1"==e&&(e="443");let s=i,o=se,l="";r=S.find(e=>e.includes(t)),r&&(o+="&proxyip="+r),0<M.length&&s.includes(".workers.dev")&&(o="/"+s+o,s=M[Math.floor(Math.random()*M.length)],l=" 已启用临时域名中转服务，请尽快绑定自定义域！"),r=atob(g);return`${r}://${c}@${t}:${e+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPQ==")+s}&fp=random&type=ws&host=${s}&path=${encodeURIComponent(o)}#`+encodeURIComponent(a+l)}).join("\n");let o=r;"true"==e&&(o+=`
`+s);return btoa(o)}(F,W,Z,t,a,r,n),d.pathname=="/"+W?e:(h=e,w=l,m=i,f=o,h=(h=f?atob(h):h).replace(new RegExp(W,"g"),w).replace(new RegExp(F,"g"),m),h=f?btoa(h):h)}catch(e){return console.error("Error fetching content:",e),"Error fetching content: "+e.message}}}async function $(r){if(!r||0===r.length)return[];let n="";const t=new AbortController;var s,e,a=setTimeout(()=>{t.abort()},2e3);try{for([s,e]of(await Promise.allSettled(r.map(e=>fetch(e,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1")},signal:t.signal}).then(e=>e.ok?e.text():Promise.reject())))).entries())if("fulfilled"===e.status){var o=await e.value,l=o.split(/\r?\n/);let t="",a="443";if(3<l[0].split(",").length){var i=r[s].match(/id=([^&]*)/),c=(i&&(t=i[1]),r[s].match(/port=([^&]*)/));c&&(a=c[1]);for(let e=1;e<l.length;e++){var p=l[e].split(",")[0];p&&(n+=`${p}:${a}${t?"#"+t:""}\n`,r[s].includes("proxyip=true"))&&S.push(p+":"+a)}}else r[s].includes("proxyip=true")&&(S=S.concat((await ce(o)).map(e=>{var t,e=e.split("#")[0]||e;return e.includes(":")?(t=e.split(":")[1],ae.includes(t)?null:e):e+":443"}).filter(Boolean))),n+=o+"\n"}}catch(e){console.error(e)}finally{clearTimeout(a)}return await ce(n)}async function U(a){if(!z||0===z.length)return[];var r=[];for(const d of z)try{var e=await fetch(d);if(e.ok){var n=await e.text();let t;var s=(t=n.includes("\r\n")?n.split("\r\n"):n.split("\n"))[0].split(",").indexOf("TLS"),o=s+de;if(-1===s)console.error("CSV文件缺少必需的字段");else for(let e=1;e<t.length;e++){var l,i,c,p=t[e].split(","),u=p.length-1;p[s].toUpperCase()===a&&parseFloat(p[u])>X&&(l=p[0],i=p[1],c=p[o],r.push(l+`:${i}#`+c),d.includes("proxyip=true"))&&"true"==p[s].toUpperCase()&&!ae.includes(i)&&S.push(l+":"+i)}}else console.error("获取CSV地址时出错:",e.status,e.statusText)}catch(e){console.error("获取CSV地址时出错:",e);continue}return r}async function ce(e){e=e.replace(/[  |"'\r\n]+/g,",").replace(/,+/g,",");return(e=","==(e=","==e.charAt(0)?e.slice(1):e).charAt(e.length-1)?e.slice(0,e.length-1):e).split(",")}function y(e){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}
